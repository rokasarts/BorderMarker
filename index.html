<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Border Marker</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="description" content="Environmental awareness app for real time wind data across country borders">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='80'>ðŸ‘¾</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
<style>
:root{--green:#1DB95C;--purple:#662FFF;--orange:#FF6200;--bg:#141F24;--text:#f1f5f9;--border:#2a4148;--padding:16px;--gap:30px}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100vh;height:100dvh;font-family:Inter,sans-serif;color:var(--text);background:var(--bg);margin:0;padding:0;overflow:hidden}
#map{position:fixed;top:0;left:0;width:100vw;height:100vh;height:100dvh;z-index:1;overflow:hidden}

/* Mobile map adjustments */
@media(max-width:1024px){
  html, body {
    height: 100vh;
    height: 100dvh; /* Use dynamic viewport height on mobile */
  }
  
  #map {
    height: 100vh;
    height: 100dvh;
    padding-bottom: calc(128px + var(--safe-bottom) + var(--padding)); /* Account for controls height */
    box-sizing: border-box;
  }
}
.leaflet-particle-layer{overflow:hidden;will-change:transform;z-index:400!important;pointer-events:none;position:absolute!important}
.leaflet-overlay-pane{z-index:200}
.leaflet-marker-pane{z-index:600}
.info{position:absolute;bottom:calc(90px + var(--gap));left:var(--padding);z-index:10;width:350px;background:var(--bg);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.5);border:1px solid var(--border);overflow:hidden}
.info-header{display:flex;align-items:center;background:var(--bg);cursor:pointer;min-height:80px;border-bottom:1px solid var(--border);transition:background-color 0.2s ease;outline:none}
.info-header:hover{background:rgba(42,65,72,0.5)}
.info-header:focus{outline:none}
.info.collapsed .info-header{border-bottom:none}
.logo{display:flex;align-items:center;justify-content:center;width:80px;height:80px;border-right:1px solid var(--border);font-size:40px;color:var(--purple)}
.info-toggle{flex:1;display:flex;align-items:center;padding:0 var(--padding);gap:12px}
.title{font-size:22px;font-weight:700;color:var(--text)}
.arrow{margin-left:auto;font-size:16px;color:var(--text);transition:transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)}
.info.collapsed .arrow{transform:rotate(180deg)}
.content{max-height:600px;overflow:hidden;transition:max-height 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)}
.info.collapsed .content{max-height:0}
.section{padding:var(--padding);border-bottom:1px solid var(--border)}
.section:last-child{border-bottom:none}
.legend{display:flex;align-items:center;gap:12px;font-size:14px;margin-bottom:12px}
.legend:last-child{margin-bottom:0}
.line{width:60px;height:6px;background:var(--orange);border-radius:3px;box-shadow:0 0 8px rgba(255,98,0,.5)}
.gradient{width:60px;height:6px;border-radius:3px;background:linear-gradient(to right,var(--green),var(--purple),var(--orange))}
.disclaimer{background:rgba(153,73,29,0.6);border:1px solid rgba(180,85,30,0.7);border-radius:8px;cursor:pointer;margin-top:16px;transition:background-color 0.2s ease}
.disclaimer:hover{background:rgba(153,73,29,0.75)}
.disclaimer-header{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;padding:12px var(--padding);text-transform:uppercase;letter-spacing:0.05em;color:rgba(255,212,196,0.95)}
.disclaimer-text{font-size:11px;line-height:1.6;max-height:0;overflow:hidden;padding:0 var(--padding);color:rgba(255,212,196,0.9);transition:max-height 0.3s cubic-bezier(0.4, 0.0, 0.2, 1),padding 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)}
.disclaimer.open .disclaimer-text{max-height:200px;padding:0 var(--padding) 12px var(--padding)}
.disclaimer .arrow{font-size:12px;color:rgba(255,212,196,0.95);transition:transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)}
.disclaimer.open .arrow{transform:rotate(180deg)}

/* Enhanced credits styling with normal capitalization and colons */
.credits{font-size:14px;line-height:1.8;margin-top:16px;display:grid;grid-template-columns:repeat(2,1fr);gap:16px 24px}
.credits-row{display:flex;flex-direction:column;gap:4px}
.credit-label{color:#7f8c96;font-size:12px;font-weight:400;letter-spacing:0.05em}
.credit-value{color:var(--text);font-size:14px;font-weight:400}
.credit-value a{color:var(--text);text-decoration:underline;transition:color 0.2s ease}
.credit-value a:hover{color:var(--orange)}

.controls{position:absolute;bottom:var(--padding);left:var(--padding);right:var(--padding);z-index:10;background:var(--bg);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.5);padding:0;display:flex;align-items:stretch;overflow:hidden;border:1px solid var(--border);height:90px}
.btn-container{display:flex;align-items:stretch;border-right:1px solid var(--border);width:180px}
button{width:100%;height:100%;padding:0 var(--padding);background:transparent;color:#fff;border:none;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;letter-spacing:0.05em;display:flex;align-items:center;justify-content:center;gap:8px;text-transform:uppercase;transition:background-color 0.2s ease}
button:hover:not(.active){background-color:rgba(255,98,0,0.15)}
button.active{background:var(--orange);opacity:0.9}
button.active:hover{opacity:1}
.dot{width:8px;height:8px;background:var(--orange);border-radius:50%}
.active .dot{background:#fff}
.live-text::after{content:' VIEW'}
.active .live-text::after{content:''}
.cell{display:flex;align-items:center;justify-content:center;border-right:1px solid var(--border);height:100%}
.cell:last-child{border-right:none}
.cell.country{width:170px}
.cell.date{width:170px}
.cell.slider{flex:1;padding:0 var(--padding)}
select{height:100%;width:100%;padding:0 var(--padding);border:none;font-size:15px;font-family:inherit;background:transparent;color:#fff;cursor:pointer;appearance:none;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;background-image:url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;transition:background-color 0.2s ease;outline:none}
select:hover{background-color:rgba(42,65,72,0.5)}
.time-slider{display:flex;align-items:center;gap:var(--padding);width:100%}

/* Enhanced time display with orange highlighting */
.time-display{font-size:15px;font-weight:700;color:var(--text);width:72px;display:flex;align-items:center;justify-content:center;text-transform:uppercase;letter-spacing:0.05em;transition:color 0.2s ease}
.time-display.selecting{color:var(--orange)}
.time-display.hovering{color:var(--orange)}

.slider-container{position:relative;height:6px;background:var(--border);border-radius:3px;flex:1}
.loading{position:absolute;top:0;left:0;height:100%;width:0%;background:var(--orange);border-radius:3px;z-index:1;will-change:width;transform:translateZ(0)}
.loading.animating{transition:width 0.6s cubic-bezier(0.25,0.46,0.45,0.94)}
.loading.complete{transition:width 0.3s ease-out,opacity 0.8s ease 0.2s;opacity:0}
input[type=range]{position:absolute;top:0;left:0;width:100%;height:6px;border-radius:3px;background:transparent;outline:none;appearance:none;z-index:2}
input[type=range]::-webkit-slider-thumb{appearance:none;width:24px;height:24px;border-radius:4px;background:var(--orange);cursor:pointer;box-shadow:0 2px 8px rgba(255,98,0,.5);margin-top:-9px;transition:transform 0.2s ease}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.1)}
input[type=range]::-webkit-slider-runnable-track{width:100%;height:6px;cursor:pointer;background:transparent;border-radius:3px}
.emoji{transform:translate(-50%,-92%);font-size:36px;cursor:pointer}
.tooltip{position:absolute;background:rgba(26,26,26,.95);color:#fff;padding:6px 10px;border-radius:6px;font-size:12px;font-weight:600;pointer-events:none;z-index:20;display:none}
.offline{position:fixed;left:50%;top:calc(var(--safe-top) + var(--padding));transform:translateX(-50%);background:#fff3cd;border:1px solid #ffe69c;color:#664d03;padding:10px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);z-index:100;font-size:13px;font-weight:600;display:none;max-width:calc(100vw - 2 * var(--padding) - var(--safe-left) - var(--safe-right));margin:0 calc(var(--padding) + var(--safe-left));word-wrap:break-word}
/* Safari mobile safe area support */
@supports (padding-top: env(safe-area-inset-top)) {
  :root {
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
    --safe-left: env(safe-area-inset-left);
    --safe-right: env(safe-area-inset-right);
  }
}

@supports not (padding-top: env(safe-area-inset-top)) {
  :root {
    --safe-top: 0px;
    --safe-bottom: 0px;
    --safe-left: 0px;
    --safe-right: 0px;
  }
}

@media(max-width:1024px){
.info{
  position: fixed;
  top: calc(var(--safe-top) + var(--padding));
  width: calc(100vw - calc(var(--padding) * 2) - var(--safe-left) - var(--safe-right));
  left: calc(var(--padding) + var(--safe-left));
  right: auto;
  bottom: auto;
  height: auto;
}

.controls{
  position: fixed;
  flex-wrap: wrap;
  height: auto;
  bottom: calc(var(--safe-bottom) + var(--padding));
  left: calc(var(--padding) + var(--safe-left));
  right: calc(var(--padding) + var(--safe-right));
  width: auto;
  border-radius: 16px;
  z-index: 1000;
}

/* Mobile-specific time interaction fixes */
.time-display {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  width: 72px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: color 0.2s ease;
  user-select: none;
  -webkit-user-select: none;
}

.time-display.selecting {
  color: var(--orange) !important;
}

.time-display.hovering {
  color: var(--orange) !important;
}

/* Remove hover and click animations for info header on mobile/tablet */
.info-header {
  transition: none;
}

.info-header:hover {
  background: var(--bg);
}

.info-header:active {
  background: var(--bg);
}

.btn-container{border-right:none;border-bottom:1px solid var(--border);width:100%;height:64px}
button{height:64px;padding:0 var(--padding)}
.cell{height:64px;border-bottom:1px solid var(--border)}
.cell.country{width:50%;border-right:1px solid var(--border)}
.cell.date{width:50%}
.cell.slider{width:100%;border-bottom:none;border-right:none}

/* Additional mobile Safari fixes */
body {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: none;
  position: fixed;
  width: 100%;
  height: 100%;
}

#map {
  /* Prevent zoom on double tap in iOS Safari */
  touch-action: pan-x pan-y;
}

/* Fix for potential viewport issues on iOS */
html {
  -webkit-text-size-adjust: 100%;
}

/* Improve touch targets on mobile */
input[type=range] {
  height: 44px; /* Minimum touch target size */
  margin-top: -19px; /* Center the larger touch target */
}

input[type=range]::-webkit-slider-thumb {
  width: 32px;
  height: 32px;
  margin-top: -13px;
}

/* Better select styling on mobile */
select {
  font-size: 16px; /* Prevent zoom on focus in iOS */
  -webkit-appearance: none;
  background-size: 16px 16px;
}
}
}
</style>
</head>
<body>
<div id="map"></div>
<div class="tooltip" id="tooltip"></div>
<div class="info" id="info">
<div class="info-header" id="toggle">
<div class="logo">ðŸ‘¾</div>
<div class="info-toggle">
<div class="title">Border Marker</div>
<span class="arrow">â–¼</span>
</div>
</div>
<div class="content">
<div class="section">
<p style="font-size:13px;color:#94a3b8;margin-bottom:16px">Environmental awareness app for real time wind data across country borders.</p>
<div class="legend"><span class="line"></span><span>Wind inflow (outside â†’ inside)</span></div>
<div class="legend"><span class="gradient"></span><span>Wind speed (low â†’ high)</span></div>
<div class="disclaimer" id="disclaimer">
<div class="disclaimer-header"><span>âš </span><span>DISCLAIMER</span><span class="arrow">â–¼</span></div>
<div class="disclaimer-text">Educational tool developed using AI. It may contain inaccuracies and is only intended to raise awareness about cross-border air incursions.</div>
</div>

<!-- Enhanced credits section with normal capitalization and colons -->
<div class="credits">
<div class="credits-row">
<span class="credit-label">Created by:</span>
<span class="credit-value"><a href="https://www.linkedin.com/in/rokasarts/" target="_blank">Rokasarts</a></span>
</div>
<div class="credits-row">
<span class="credit-label">Wind:</span>
<span class="credit-value">Open-Meteo / met.no</span>
</div>
<div class="credits-row">
<span class="credit-label">Map:</span>
<span class="credit-value">OpenStreetMap</span>
</div>
<div class="credits-row">
<span class="credit-label">Boundaries:</span>
<span class="credit-value">OSM/Nominatim</span>
</div>
</div>
</div>
</div>
</div>
<div class="controls">
<div class="btn-container">
<button id="live"><span class="dot"></span><span class="live-text">LIVE</span></button>
</div>
<div class="cell country">
<select id="country">
<option value="Lithuania">ðŸ‡±ðŸ‡¹ Lithuania</option>
<option value="Latvia">ðŸ‡±ðŸ‡» Latvia</option>
<option value="Estonia">ðŸ‡ªðŸ‡ª Estonia</option>
<option value="Poland">ðŸ‡µðŸ‡± Poland</option>
<option value="Ukraine">ðŸ‡ºðŸ‡¦ Ukraine</option>
</select>
</div>
<div class="cell date">
<select id="date"></select>
</div>
<div class="cell slider">
<div class="time-slider">
<span class="time-display" id="timeDisplay">12:00</span>
<div class="slider-container">
<div class="loading" id="loading"></div>
<input type="range" min="0" max="23" step="1" value="0" id="hour">
</div>
</div>
</div>
</div>
<div id="offline" class="offline"></div>
<script>
// Configuration
const CFG={
DAYS:6,STEP:5,SAMPLE:40,ANGLE:80,SIMPLIFY:2.5,
CONCUR:Math.max(1,Math.min(8,Math.floor((navigator.hardwareConcurrency||4)/2))),
LINE_W:5.5,PARTICLES:12,LIFE:100,SPEED:[0.07,0.5,2.2],WIND:[10,30],
COLORS:['#1DB95C','#662FFF','#FF6200'],NIGHT:20,
UA:'BorderMarker/1.0 (Educational; Rokasarts)'
};

const COORDS={
Lithuania:{lat:55.169,lon:23.881},Latvia:{lat:56.879,lon:24.603},
Estonia:{lat:58.595,lon:25.013},Poland:{lat:51.919,lon:19.145},
Ukraine:{lat:48.379,lon:31.165}
};

// Utilities
const $=(id)=>document.getElementById(id);
const norm=a=>(a%360+360)%360;
const angDiff=(a,b)=>{const d=Math.abs(norm(a)-norm(b));return d>180?360-d:d};
const km2deg=km=>km/111;
const snapKey=v=>(Math.round(v*50)/50).toFixed(2);

// Color utilities - merged
const hex2rgba=(h,a=1)=>{
const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);
return`rgba(${r},${g},${b},${a})`;
};

const interp=(h1,h2,t,a=1)=>{
const r1=parseInt(h1.slice(1,3),16),g1=parseInt(h1.slice(3,5),16),b1=parseInt(h1.slice(5,7),16);
const r2=parseInt(h2.slice(1,3),16),g2=parseInt(h2.slice(3,5),16),b2=parseInt(h2.slice(5,7),16);
const r=Math.round(r1+(r2-r1)*t),g=Math.round(g1+(g2-g1)*t),b=Math.round(b1+(b2-b1)*t);
return`rgba(${r},${g},${b},${a})`;
};

const getWindColor=s=>{
const[lo,hi]=CFG.WIND,[c1,c2,c3]=CFG.COLORS;
if(s<lo)return interp(c1,c2,s/lo,.95);
if(s<hi)return interp(c2,c3,(s-lo)/(hi-lo),.95);
return hex2rgba(c3,.95);
};

// State and cache
const cache={wind:new Map(),country:new Map()};
const state={
feature:null,rings:[],samples:[],timeIdx:0,borderLayer:null,
redLayer:null,abort:null,country:'Lithuania',particleLayer:null,isLoaded:false
};

// Map initialization
const map=L.map('map',{zoomControl:true}).setView([54.7,25.3],6);
const tiles=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
attribution:'Â© OpenStreetMap'
}).addTo(map);

const tileContainer=tiles.getContainer();
if(tileContainer)tileContainer.style.transition='opacity 0.8s ease-out';

const balloon=L.marker([53.9,27.56],{
icon:L.divIcon({className:'emoji',html:'ðŸ‘¾',iconSize:[40,40]})
}).addTo(map);

// Async utilities - optimized pooling
async function poolAll(items,fn,size=4,onProg){
size=Math.max(1,Math.floor(size));
return new Promise(resolve=>{
const out=new Array(items.length);
let i=0,running=0,done=0;
const total=items.length;
const bump=()=>{if(onProg)onProg(done,total)};
const next=()=>{
while(running<size&&i<items.length){
const idx=i++;
running++;
Promise.resolve(fn(items[idx],idx))
.then(v=>{out[idx]=v})
.catch(e=>{console.warn(`Task ${idx} failed:`,e?.message||e);out[idx]=null})
.finally(()=>{
running--;
done++;
bump();
if(done===items.length)resolve(out);
else next();
});
}
};
bump();
next();
});
}

async function retry(fn,tries=2,delay=250){
let lastErr;
for(let i=0;i<tries;i++){
try{return await fn()}
catch(e){
if(e&&(e.name==='AbortError'||e.code===20))throw e;
lastErr=e;
if(i<tries-1)await new Promise(r=>setTimeout(r,delay));
}
}
throw lastErr;
}

// Tile opacity for day/night cycle
function updateTileOpacity(date,country){
const coords=COORDS[country]||{lat:54.7,lon:25.3};
const t=SunCalc.getTimes(date,coords.lat,coords.lon);
const now=date.getTime(),maxDim=CFG.NIGHT/100;
let dim=0;
if(now<t.dawn.getTime())dim=maxDim;
else if(now<t.sunrise.getTime())
dim=maxDim*(1-(now-t.dawn.getTime())/Math.max(1,t.sunrise.getTime()-t.dawn.getTime()));
else if(now<t.sunset.getTime())dim=0;
else if(now<t.dusk.getTime())
dim=maxDim*((now-t.sunset.getTime())/Math.max(1,t.dusk.getTime()-t.sunset.getTime()));
else dim=maxDim;
tiles.setOpacity(1-dim);
}

// API fetching
async function fetchCountry(country){
if(cache.country.has(country))return cache.country.get(country);
const url=`https://nominatim.openstreetmap.org/search?format=geojson&limit=1&polygon_geojson=1&polygon_threshold=0.01&country=${encodeURIComponent(country)}`;
const feature=await retry(async()=>{
const res=await fetch(url,{headers:{Accept:'application/geo+json','User-Agent':CFG.UA}});
if(!res.ok)throw new Error(`Nominatim ${res.status}`);
const data=await res.json();
if(!data.features?.length)throw new Error('No polygon for '+country);
return data.features[0];
},2,300);
cache.country.set(country,feature);
return feature;
}

async function fetchWindMetNo(lat,lon,signal){
const url=`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`;
const res=await fetch(url,{signal,headers:{Accept:'application/json','User-Agent':CFG.UA}});
if(!res.ok)throw new Error(`met.no ${res.status}`);
const data=await res.json();
const series=data?.properties?.timeseries||[];
if(!series.length)throw new Error('met.no empty');
const time=[],dir=[],spd=[];
for(const row of series){
const details=row?.data?.instant?.details||{};
const d=details.wind_from_direction;
const s=details.wind_speed;
if(typeof d==='number'&&typeof s==='number'){
time.push(new Date(row.time));
dir.push(d);
spd.push(s*3.6);
}
}
if(!time.length)throw new Error('met.no: no usable wind points');
return{time,dir,spd};
}

async function fetchWind(lat,lon,signal){
const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=wind_speed_10m,wind_direction_10m&forecast_days=${CFG.DAYS}&timezone=auto&windspeed_unit=kmh`;
try{
return await retry(async()=>{
const res=await fetch(url,{signal});
if(!res.ok)throw new Error(`Open-Meteo ${res.status}`);
const data=await res.json();
if(!data?.hourly?.time||!data.hourly.wind_speed_10m||!data.hourly.wind_direction_10m)
throw new Error('Open-Meteo payload missing');
return{
time:data.hourly.time.map(t=>new Date(t)),
dir:data.hourly.wind_direction_10m,
spd:data.hourly.wind_speed_10m
};
},2,300);
}catch(e){
console.warn('Open-Meteo failed, trying met.no:',e?.message||e);
return await retry(()=>fetchWindMetNo(lat,lon,signal),2,300);
}
}

async function cachedWind(lat,lon,signal){
const key=`${snapKey(lat)},${snapKey(lon)}`;
if(cache.wind.has(key))return cache.wind.get(key);
const val=await fetchWind(lat,lon,signal);
cache.wind.set(key,val);
return val;
}

// Geometry processing
function simplify(feat){
return turf.simplify(feat,{tolerance:km2deg(CFG.SIMPLIFY),highQuality:false,mutate:false});
}

function extractRings(feat){
const g=feat.geometry;
if(g.type==='Polygon')return[g.coordinates[0]];
if(g.type==='MultiPolygon')return g.coordinates.map(p=>p[0]);
return[];
}

function resample(ring){
const line=turf.lineString(ring);
const len=turf.length(line,{units:'kilometers'});
const n=Math.max(20,Math.floor(len/CFG.STEP));
const coords=[];
for(let i=0;i<=n;i++){
const p=turf.along(line,(i/n)*len,{units:'kilometers'});
coords.push([p.geometry.coordinates[1],p.geometry.coordinates[0]]);
}
return coords;
}

function sampleWind(ring){
const line=turf.lineString(ring);
const len=turf.length(line,{units:'kilometers'});
const n=Math.max(6,Math.floor(len/CFG.SAMPLE));
const pts=[];
const isCW=turf.booleanClockwise(ring);
for(let i=0;i<n;i++){
const s=(i/n)*len,e=((i+1)/n)*len;
const A=turf.along(line,s,{units:'kilometers'});
const B=turf.along(line,e,{units:'kilometers'});
const M=turf.midpoint(A,B);
const bearing=turf.bearing(A,B);
const outward=norm(bearing+(isCW?-90:90));
pts.push({
a:A.geometry.coordinates,b:B.geometry.coordinates,
m:M.geometry.coordinates,bearing,outward
});
}
return pts;
}

// Layer management
function clearLayers(){
if(state.redLayer){state.redLayer.remove();state.redLayer=null}
if(state.borderLayer){state.borderLayer.remove();state.borderLayer=null}
}

function drawBorder(){
const ringLayers=state.rings.map(r=>
L.polyline(resample(r),{color:'#101010',weight:4,opacity:.95})
);
state.borderLayer=L.layerGroup(ringLayers).addTo(map);
const all=ringLayers.flatMap(l=>l.getLatLngs()).flat();
if(all.length)map.fitBounds(L.latLngBounds(all),{padding:[18,18]});
}

function computeInflow(idx){
return state.samples.map(s=>{
const d=s.wind?.dir[idx];
if(d==null)return false;
return angDiff(d,s.outward)<=CFG.ANGLE;
});
}

// Tooltip utilities
function showTooltip(x,y,html){
const el=$('tooltip');
el.innerHTML=html;
el.style.display='block';
el.style.left=(x+10)+'px';
el.style.top=(y-28)+'px';
}

function hideTooltip(){$('tooltip').style.display='none'}

function nearestSample(latlng,indices){
const lon=latlng.lng,lat=latlng.lat;
let best=null,bestD=Infinity,bestIdx=-1;
for(const si of indices){
const s=state.samples[si];
if(!s)continue;
const dx=lon-s.m[0],dy=lat-s.m[1];
const d=dx*dx+dy*dy;
if(d<bestD){bestD=d;best=s;bestIdx=si;}
}
return{sample:best,idx:bestIdx};
}

function drawInflow(inflowFlags){
if(state.redLayer)state.redLayer.remove();
const polylines=[],metaIdx=[];
let cur=[],curIdxs=[];
for(let i=0;i<state.samples.length;i++){
if(inflowFlags[i]){
const s=state.samples[i];
if(!cur.length)cur.push([s.a[1],s.a[0]]);
cur.push([s.b[1],s.b[0]]);
curIdxs.push(i);
}else if(cur.length){
polylines.push(cur);
metaIdx.push(curIdxs);
cur=[];
curIdxs=[];
}
}
if(cur.length){polylines.push(cur);metaIdx.push(curIdxs);}

const layers=[];
polylines.forEach((coords,chunkIdx)=>{
const indices=metaIdx[chunkIdx];
const onHover=(e)=>{
const latlng=e.latlng||(e.originalEvent?map.mouseEventToLatLng(e.originalEvent):null);
if(!latlng)return hideTooltip();
const{sample}=nearestSample(latlng,indices);
if(!sample||!sample.wind)return hideTooltip();
const spd=sample.wind.spd[state.timeIdx];
if(spd==null)return hideTooltip();
const pt=map.latLngToContainerPoint([latlng.lat,latlng.lng]);
showTooltip(pt.x,pt.y,`inflow | ${Math.round(spd)} km/h`);
};
const hit=L.polyline(coords,{
color:'#000',opacity:0,weight:32,interactive:true,bubblingMouseEvents:false
}).on('mousemove',onHover).on('mouseout',hideTooltip);
const glow=L.polyline(coords,{
color:hex2rgba(CFG.COLORS[2],.45),weight:18,opacity:.7,interactive:false
});
const core=L.polyline(coords,{
color:CFG.COLORS[2],weight:10,opacity:.97,lineCap:'round',interactive:false
});
layers.push(glow,core,hit);
});
state.redLayer=L.layerGroup(layers).addTo(map);
}

// Particle system - optimized
const ParticleLayer=L.Layer.extend({
onAdd:function(map){
this._map=map;
this._canvas=L.DomUtil.create('canvas','leaflet-particle-layer');
this._canvas.style.position='absolute';
this._canvas.style.pointerEvents='none';
this._canvas.style.zIndex='400';
const pane=map.getPanes().overlayPane;
pane.appendChild(this._canvas);
map.on('viewreset zoom',this._reset,this);
map.on('move',this._update,this);
map.on('resize',this._reset,this);
this._particles=[];
this._animating=false;
this._reset();
this._startAnimation();
},
onRemove:function(map){
map.off('viewreset zoom move resize',this._reset,this);
this._stopAnimation();
if(this._canvas?.parentNode)this._canvas.parentNode.removeChild(this._canvas);
this._canvas=null;
hideTooltip();
},
_reset:function(){
if(!this._map||!this._canvas)return;
const bounds=this._map.getBounds();
const topLeft=this._map.latLngToLayerPoint(bounds.getNorthWest());
const bottomRight=this._map.latLngToLayerPoint(bounds.getSouthEast());
const canvasWidth=bottomRight.x-topLeft.x;
const canvasHeight=bottomRight.y-topLeft.y;
const ratio=window.devicePixelRatio||1;
this._canvas.width=Math.round(canvasWidth*ratio);
this._canvas.height=Math.round(canvasHeight*ratio);
this._canvas.style.width=canvasWidth+'px';
this._canvas.style.height=canvasHeight+'px';
this._canvas.style.transform=`translate3d(${topLeft.x}px,${topLeft.y}px,0px)`;
const ctx=this._canvas.getContext('2d');
if(ctx)ctx.setTransform(ratio,0,0,ratio,0,0);
this._canvasWidth=canvasWidth;
this._canvasHeight=canvasHeight;
this._pixelRatio=ratio;
this._topLeft=topLeft;
this._bounds=bounds;
},
_update:function(){
if(!this._map||!this._canvas)return;
const bounds=this._map.getBounds();
const topLeft=this._map.latLngToLayerPoint(bounds.getNorthWest());
this._canvas.style.transform=`translate3d(${topLeft.x}px,${topLeft.y}px,0px)`;
this._topLeft=topLeft;
this._bounds=bounds;
},
_startAnimation:function(){
if(!this._animating){
this._animating=true;
this._animate();
}
},
_stopAnimation:function(){
this._animating=false;
if(this._raf){cancelAnimationFrame(this._raf);this._raf=null;}
},
setParticles:function(particles){
this._particles=particles?.filter(p=>
p&&typeof p.lat==='number'&&typeof p.lon==='number'&&
!isNaN(p.lat)&&!isNaN(p.lon)&&
Math.abs(p.lat)<=90&&Math.abs(p.lon)<=180
)||[];
this._startAnimation();
},
setVector:function(fn){this._vectorAt=fn},
_isParticleVisible:function(p){
if(!this._bounds)return false;
const padding=0.1;
return p.lat>=this._bounds.getSouth()-padding&&
p.lat<=this._bounds.getNorth()+padding&&
p.lon>=this._bounds.getWest()-padding&&
p.lon<=this._bounds.getEast()+padding;
},
_animate:function(){
if(!this._animating||!this._canvas||!this._map||!this._bounds){
if(this._animating)this._raf=requestAnimationFrame(this._animate.bind(this));
return;
}
const ctx=this._canvas.getContext('2d');
if(!ctx)return;
ctx.save();
ctx.setTransform(this._pixelRatio||1,0,0,this._pixelRatio||1,0,0);
ctx.clearRect(0,0,this._canvasWidth,this._canvasHeight);
if(this._particles&&this._particles.length>0){
ctx.globalCompositeOperation='source-over';
const sizeBase=CFG.LINE_W;
for(const p of this._particles){
if(!p)continue;
if(!this._isParticleVisible(p)){
const dist=Math.abs(p.lat-p.origLat)+Math.abs(p.lon-p.origLon);
if(dist>0.5){
p.lat=p.origLat+(Math.random()-0.5)*0.04;
p.lon=p.origLon+(Math.random()-0.5)*0.04;
p.life=CFG.LIFE+Math.floor(Math.random()*30);
}
continue;
}
const particlePoint=this._map.latLngToLayerPoint([p.lat,p.lon]);
const x=particlePoint.x-this._topLeft.x;
const y=particlePoint.y-this._topLeft.y;
const margin=50;
if(x<-margin||x>this._canvasWidth+margin||y<-margin||y>this._canvasHeight+margin)continue;
const v=this._vectorAt?this._vectorAt(p.lat,p.lon):{vx:0,vy:0,speed:0};
if(v.speed>0.3){
const intensity=Math.min(1,v.speed/25);
ctx.globalAlpha=0.6+intensity*0.4;
const particleSize=sizeBase+intensity*2;
ctx.fillStyle=getWindColor(v.speed);
const drawX=Math.round(x-particleSize/2);
const drawY=Math.round(y-particleSize/2);
if(drawX>-particleSize&&drawX<this._canvasWidth+particleSize&&
drawY>-particleSize&&drawY<this._canvasHeight+particleSize){
ctx.fillRect(drawX,drawY,particleSize,particleSize);
}
}
if(v.speed>0.1){
const windDir=bestWindDir(p.lat,p.lon);
if(windDir!==null&&!isNaN(windDir)){
const radians=(windDir+180)*Math.PI/180;
const speedMultiplier=1+Math.log(Math.max(1,v.speed/5))*0.8;
const moveSpeed=0.0015*speedMultiplier*Math.min(2,v.speed*0.2);
const newLat=p.lat+Math.cos(radians)*moveSpeed;
const newLon=p.lon+Math.sin(radians)*moveSpeed;
if(Math.abs(newLat)<=85&&Math.abs(newLon)<=180){
p.lat=newLat;
p.lon=newLon;
}
}
}
p.life--;
if(p.life<=0){
p.lat=p.origLat+(Math.random()-0.5)*0.04;
p.lon=p.origLon+(Math.random()-0.5)*0.04;
p.life=CFG.LIFE+Math.floor(Math.random()*30);
}
}
}
ctx.restore();
if(this._animating)this._raf=requestAnimationFrame(this._animate.bind(this));
}
});

function bestWindDir(lat,lon){
if(!state.samples||!state.samples.length)return null;
let bestSample=null,bestDistance=Infinity;
for(const sample of state.samples){
if(!sample?.m||!sample.wind?.dir)continue;
const dx=lon-sample.m[0],dy=lat-sample.m[1];
const distance=dx*dx+dy*dy;
if(distance<bestDistance){bestDistance=distance;bestSample=sample;}
}
if(!bestSample?.wind.dir)return null;
const timeIdx=state.timeIdx||0;
const windDir=bestSample.wind.dir[timeIdx];
return(windDir!=null&&!isNaN(windDir))?windDir:null;
}

function initParticles(){
if(state.particleLayer){
try{
if(map.hasLayer(state.particleLayer))map.removeLayer(state.particleLayer);
}catch(e){console.warn('Error removing particle layer:',e)}
state.particleLayer=null;
}
const validSamples=state.samples.filter(s=>
s&&s.wind&&s.wind.dir&&s.wind.spd&&
Array.isArray(s.wind.dir)&&Array.isArray(s.wind.spd)&&
s.wind.dir.length>0&&s.m&&Array.isArray(s.m)&&s.m.length>=2&&
typeof s.m[0]==='number'&&typeof s.m[1]==='number'&&
!isNaN(s.m[0])&&!isNaN(s.m[1])
);
if(!validSamples.length)return;
try{
state.particleLayer=new ParticleLayer();
state.particleLayer.addTo(map);
state.particleLayer.setVector((lat,lon)=>getVector(lat,lon));
const particleCount=Math.min(600,Math.max(200,validSamples.length*6));
const particleList=[];
for(let i=0;i<particleCount;i++){
const sample=validSamples[Math.floor(Math.random()*validSamples.length)];
const spread=0.04;
const lat=sample.m[1]+(Math.random()-0.5)*spread;
const lon=sample.m[0]+(Math.random()-0.5)*spread;
if(Math.abs(lat)<=90&&Math.abs(lon)<=180){
particleList.push({
lat,lon,origLat:lat,origLon:lon,
life:Math.floor((i/particleCount)*CFG.LIFE)
});
}
}
setTimeout(()=>{
if(state.particleLayer)state.particleLayer.setParticles(particleList);
},100);
}catch(e){
console.error('Particle error:',e);
state.particleLayer=null;
}
}

function getVector(lat,lon){
if(!state.samples||!state.samples.length)return{vx:0,vy:0,speed:0};
let bestSample=null,bestDistance=Infinity;
for(const sample of state.samples){
if(!sample?.m||!sample.wind?.dir||!sample.wind?.spd)continue;
const dx=lon-sample.m[0],dy=lat-sample.m[1];
const distance=dx*dx+dy*dy;
if(distance<bestDistance){bestDistance=distance;bestSample=sample;}
}
if(!bestSample)return{vx:0,vy:0,speed:0};
const timeIdx=state.timeIdx||0;
const windDir=bestSample.wind.dir[timeIdx];
const windSpeed=bestSample.wind.spd[timeIdx];
if(windDir==null||windSpeed==null||isNaN(windDir)||isNaN(windSpeed))
return{vx:0,vy:0,speed:0};
return{vx:0,vy:0,speed:Math.max(0,windSpeed)};
}

// Date/time management
function buildDates(firstWind){
$('date').innerHTML='';
const fmt=new Intl.DateTimeFormat('en-CA',{year:'numeric',month:'2-digit',day:'2-digit'});
const days=new Map();
for(const dt of firstWind.time){
const mid=+new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
if(!days.has(mid))days.set(mid,fmt.format(new Date(mid)));
if(days.size>=CFG.DAYS)break;
}
for(const[mid,label]of days){
const opt=document.createElement('option');
opt.value=String(mid);
opt.textContent=label;
$('date').appendChild(opt);
}
}

function selectHour(){
const first=state.samples.find(s=>s.wind)?.wind;
if(!first)return 0;
const activeLocalMidnight=Number($('date').value);
const target=new Date(activeLocalMidnight);
target.setHours(+$('hour').value,0,0,0);
let bestIdx=0,bestDelta=Infinity;
for(let i=0;i<first.time.length;i++){
const dt=Math.abs(first.time[i]-target);
if(dt<bestDelta){bestDelta=dt;bestIdx=i;if(dt===0)break;}
}
return bestIdx;
}

function applyTime(){
state.timeIdx=selectHour();
const first=state.samples.find(s=>s.wind)?.wind;
const ts=first?.time?.[state.timeIdx]||new Date();
const hh=String(ts.getHours()).padStart(2,'0');
const mm=String(ts.getMinutes()).padStart(2,'0');
$('timeDisplay').textContent=`${hh}:${mm}`;
updateTileOpacity(ts,state.country);
drawInflow(computeInflow(state.timeIdx));
checkLive();
}

function checkLive(){
const now=new Date();
const localMidnight=+new Date(now.getFullYear(),now.getMonth(),now.getDate());
const isLive=Number($('date').value)===localMidnight&&Number($('hour').value)===now.getHours();
$('live').classList.toggle('active',isLive);
}

function snapLive(){
const now=new Date();
$('date').value=String(+new Date(now.getFullYear(),now.getMonth(),now.getDate()));
$('hour').value=now.getHours();
applyTime();
}

// Progress bar
function setProgress(pct){
const bar=$('loading');
const v=Math.min(100,Math.max(0,pct));
if(!bar.classList.contains('animating'))bar.classList.add('animating');
bar.style.width=v+'%';
}

function showLoading(show){
const bar=$('loading');
if(show){
bar.className='loading';
bar.style.width='0%';
bar.style.opacity='1';
void bar.offsetWidth;
bar.classList.add('animating');
}else{
bar.style.width='100%';
setTimeout(()=>{
bar.classList.remove('animating');
bar.classList.add('complete');
setTimeout(()=>{bar.className='loading';bar.style.width='0%';bar.style.opacity='1'},1000);
},100);
}
const disabled=show;
$('country').disabled=disabled;
$('date').disabled=disabled;
$('hour').disabled=disabled;
$('live').disabled=disabled;
}

function showOffline(msg){
const el=$('offline');
el.textContent=msg||'You appear to be offline or the data service is unavailable.';
el.style.display='block';
clearTimeout(showOffline._t);
showOffline._t=setTimeout(()=>{el.style.display='none'},6000);
}

// Main loading function
async function loadCountry(country,preserveTime=false){
if(state.abort)state.abort.abort();
state.abort=new AbortController();
const{signal}=state.abort;
const savedDate=preserveTime?$('date').value:null;
const savedHour=preserveTime?$('hour').value:null;
showLoading(true);
clearLayers();
if(state.particleLayer){
try{
if(map.hasLayer(state.particleLayer))map.removeLayer(state.particleLayer);
state.particleLayer._animating=false;
if(state.particleLayer._raf)cancelAnimationFrame(state.particleLayer._raf);
}catch(e){console.warn('Particle cleanup error:',e)}
state.particleLayer=null;
}
state.country=country;
state.isLoaded=false;
try{
setProgress(5);
state.feature=simplify(await fetchCountry(country));
setProgress(20);
state.rings=extractRings(state.feature);
drawBorder();
setProgress(28);
state.samples=state.rings.flatMap(r=>sampleWind(r));
setProgress(30);
const total=state.samples.length||1;
const winds=await poolAll(
state.samples,
(s)=>cachedWind(s.m[1],s.m[0],signal),
CFG.CONCUR,
(completed)=>setProgress(30+(completed/total)*70)
);
state.samples.forEach((s,i)=>{s.wind=winds[i]});
if(!state.samples.some(s=>s.wind)){
const c=COORDS[country]||{lat:54.7,lon:25.3};
const fallback=await cachedWind(c.lat,c.lon,signal);
if(state.samples[0])state.samples[0].wind=fallback;
showOffline('Wind data partially unavailable. Showing limited timeline.');
}
const first=state.samples.find(s=>s.wind)?.wind;
if(first){
buildDates(first);
if(preserveTime&&savedDate&&savedHour){
const dateExists=Array.from($('date').options).some(opt=>opt.value===savedDate);
if(dateExists){
$('date').value=savedDate;
$('hour').value=savedHour;
}else snapLive();
}else snapLive();
state.isLoaded=true;
applyTime();
setTimeout(()=>{
if(state.isLoaded&&state.country===country)initParticles();
},300);
}else{
$('date').innerHTML='';
showOffline('No wind timeline available right now.');
}
}catch(e){
if(e.name!=='AbortError'){
console.error('Error loading country:',e);
showOffline('Network or API error. Map might be incomplete; please retry.');
}
}finally{showLoading(false)}
}

// UI initialization
function setInitialPanel(){
if(window.innerWidth<=1024)$('info').classList.add('collapsed');
else $('info').classList.remove('collapsed');
}

// Enhanced time display interactions
function setupTimeInteractions(){
const timeDisplay = $('timeDisplay');
const hourSlider = $('hour');
const sliderContainer = document.querySelector('.slider-container');

// Mobile and desktop event handling
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

// Highlight clock when interacting with slider
const addSelectingClass = () => timeDisplay.classList.add('selecting');
const removeSelectingClass = () => timeDisplay.classList.remove('selecting');

if (isMobile) {
  // Touch events for mobile
  hourSlider.addEventListener('touchstart', addSelectingClass, {passive: true});
  hourSlider.addEventListener('touchend', removeSelectingClass, {passive: true});
  hourSlider.addEventListener('touchcancel', removeSelectingClass, {passive: true});
  
  // Enhanced mobile slider interaction highlighting
  hourSlider.addEventListener('input', () => {
    timeDisplay.classList.add('selecting');
    // Keep highlighting for a bit longer on mobile
    setTimeout(() => {
      if (!hourSlider.matches(':active')) {
        timeDisplay.classList.remove('selecting');
      }
    }, 100);
  });
  
  hourSlider.addEventListener('change', () => {
    setTimeout(removeSelectingClass, 200);
  });
} else {
  // Mouse events for desktop
  hourSlider.addEventListener('mousedown', addSelectingClass);
  hourSlider.addEventListener('mouseup', removeSelectingClass);
}

// Highlight clock when hovering over slider area (desktop only)
if (!isMobile) {
  sliderContainer.addEventListener('mouseenter', () => {
    timeDisplay.classList.add('hovering');
  });

  sliderContainer.addEventListener('mouseleave', () => {
    timeDisplay.classList.remove('hovering');
  });
}

// Clean up on document events
document.addEventListener('mouseup', removeSelectingClass);
document.addEventListener('touchend', removeSelectingClass, {passive: true});
}

function init(){
$('date').innerHTML='';
$('hour').value=new Date().getHours();
$('date').onchange=applyTime;
$('hour').oninput=applyTime;
$('live').onclick=snapLive;
$('country').onchange=async()=>{await loadCountry($('country').value,true)};
$('toggle').onclick=()=>{$('info').classList.toggle('collapsed')};
let disclaimerToggling=false;
$('disclaimer').onclick=()=>{
if(disclaimerToggling)return;
disclaimerToggling=true;
$('disclaimer').classList.toggle('open');
setTimeout(()=>{disclaimerToggling=false},300);
};
document.addEventListener('visibilitychange',()=>{
if(document.hidden)disclaimerToggling=false;
});

// Initialize enhanced time interactions
setupTimeInteractions();
}

// Balloon easter egg
balloon.on('click',()=>{
const el=balloon.getElement();
if(!el)return;
if(balloon._timers){
balloon._timers.forEach(t=>clearTimeout(t));
balloon._timers=[];
}
el.style.transition='';
el.style.opacity='1';
el.innerHTML='ðŸ’¥';
const t1=setTimeout(()=>{
el.style.transition='opacity 1.5s ease';
el.style.opacity='0';
},500);
const t2=setTimeout(()=>{
el.innerHTML='ðŸ‘¾';
el.style.transition='';
el.style.opacity='0';
requestAnimationFrame(()=>{
el.style.transition='opacity 0.5s ease';
el.style.opacity='1';
});
},4000);
balloon._timers=[t1,t2];
});

// Initialize app
setInitialPanel();
window.addEventListener('resize',setInitialPanel);
init();
loadCountry($('country').value);
</script>
</body>
</html>
